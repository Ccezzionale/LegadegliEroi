<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Svincolati</title>
  <!-- Ri-uso lo stesso CSS della Draft Room -->
  <link rel="stylesheet" href="svincolati.css" />
  <style>
    /* Mini ritocchi locali (facoltativi) */
    .count { text-align:center; color:#001f3f; font-weight:700; margin:10px 0; }
    .hint { text-align:center; color:#6b7280; font-size:.9rem; margin-top:4px; }
    .table-wrap { background:#fff; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.1); padding:10px; width:100%; }

    /* Allarga e centra il contenitore pagina */
    .container{ display:flex; flex-direction:column; gap:16px; padding:0 20px 30px; max-width:1200px; margin:0 auto; }
    .lista-container{ width:100%; }

    /* Layout filtri: 2 colonne x 2 righe (allineati) */
    .filters-grid{ display:grid; grid-template-columns:repeat(2, minmax(420px,1fr)); gap:16px; margin-bottom:8px; width:100%; }
    .filters-col{ display:grid; grid-template-rows:auto auto; gap:10px; }
    .form-field label{ display:block; font-weight:600; color:#001f3f; margin-bottom:4px; }
    .form-field input, .form-field select{ width:100%; }

    @media (max-width:1024px){
      .filters-grid{ grid-template-columns:repeat(2, minmax(300px,1fr)); }
    }
    @media (max-width:768px){
      .filters-grid{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>

  <!-- NAVBAR (stessa della Draft Room, con hamburger su mobile) -->
  <nav>
    <div class="nav-left">
      <span id="hamburger" class="hamburger">‚ò∞</span>
      <a href="index.html" class="home-icon">üè†</a>
    </div>
    <ul class="navbar" id="mainMenu">
      <li><a href="rose.html">Rose</a></li>
      <li class="dropdown">
        <a href="#" class="toggle-submenu">Draft ‚ñæ</a>
        <ul class="submenu">
          <li><a href="draft_championship.html">üü¶ Conf.Championship</a></li>
          <li><a href="draft_conference.html">üü® Conf.League</a></li>
          <li><a href="dinamico-draft.html">üßë‚Äçüíº Draft 2026</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a href="#" class="toggle-submenu">Competizioni ‚ñæ</a>
        <ul class="submenu">
          <li><a href="classifica.html">üìä Classifiche</a></li>
          <li><a href="playoff.html">üèÜ Playoff</a></li>
          <li><a href="arena.html">üèüÔ∏è Higlander</a></li>
          <li><a href="crashoutcup.html">üí• Crash out Cup</a></li>
          <li><a href="crashoutplayoff.html">üí• Crash out Cup - Playoff</a></li>
           <li><a href="statistiche.html">üîé Statistiche</a></li>
        </ul>
      </li>
      <li><a href="svincolati.html">Svincolati</a></li>
      <li><a href="chiamate.html">Chiamate</a></li>
      <li class="dropdown">
        <a href="#" class="toggle-submenu">Hall of Fame ‚ñæ</a>
        <ul class="submenu">
          <li><a href="medagliere.html">üëë Albo d'Oro</a></li>
          <li><a href="albo.html">üèÖ  Medagliere</a></li>
        </ul>
      </li>
      <li><a href="regolamento.html">Regolamento</a></li>
    </ul>
  </nav>

  <h1 class="titolo-pagina">üìã Svincolati <span id="spinner" class="spinner" style="display:none"></span></h1>

  <div class="container" style="display:flex; flex-direction:column; gap:16px; padding: 0 20px 30px;">
    <div class="lista-container table-wrap">
      <div class="filters-grid">
        <div class="filters-col">
          <div class="form-field">
            <label for="filtroSerieA">Filtra per Squadra Serie A:</label>
            <select id="filtroSerieA"><option value="">-- Tutte --</option></select>
          </div>
          <div class="form-field">
            <label for="searchGiocatore">Cerca Giocatore:</label>
            <input id="searchGiocatore" placeholder="Digita un nome..." type="text"/>
          </div>
        </div>
        <div class="filters-col">
          <div class="form-field">
            <label for="cercaRuolo">Filtra per Ruolo:</label>
            <input type="text" id="cercaRuolo" placeholder="Cerca ruolo..." />
          </div>
          <div class="form-field">
            <label for="filtroRuolo">Seleziona Ruolo:</label>
            <select id="filtroRuolo"><option value="">-- Tutti i Ruoli --</option></select>
          </div>
        </div>
      </div>

      <div id="lista-giocatori-scroll">
        <table id="lista-giocatori-table">
          <thead>
            <tr>
              <th onclick="ordinaLista(0)">Giocatore</th>
              <th onclick="ordinaLista(1)">Ruolo</th>
              <th onclick="ordinaLista(2)">Squadra</th>
              <th onclick="ordinaLista(3, true)">Quotazione</th>
              <th onclick="ordinaLista(4)">U21</th>
            </tr>
          </thead>
          <tbody id="lista-giocatori"></tbody>
        </table>
      </div>
      <div class="count" id="count"></div>
      <div class="hint">CSV atteso con colonne: <code>Giocatore, Ruolo, Squadra, Quotazione, U21</code>.</div>
    </div>
  </div>

  <script>
    // ===== NAV: hamburger + sottomenu =====
    document.addEventListener("DOMContentLoaded", function () {
      const hamburger = document.getElementById("hamburger");
      const mainMenu = document.getElementById("mainMenu");
      const submenuToggles = document.querySelectorAll(".toggle-submenu");
      hamburger?.addEventListener("click", () => { mainMenu.classList.toggle("show"); });
      submenuToggles.forEach(t => t.addEventListener("click", function(e){ e.preventDefault(); this.closest(".dropdown").classList.toggle("show"); }));
    });
  </script>
<script>
// =============================
//  SVINCOLATI ‚Äì LOGICA PAGINA (live: no cache TTL, auto-refresh 1m)
// =============================

// URL export stabile da Google Sheets (no 2PACX) + override via ?id=...&gid=...
var DATASET = (function () {
  var DEFAULT_ID  = '17km50RcQysN4HKJJ8J4yTY1NDytSlW73KMTz0VvxDDw';
  var DEFAULT_GID = '0';
  var p   = new URLSearchParams(window.location.search);
  var id  = p.get('id')  || DEFAULT_ID;
  var gid = p.get('gid') || DEFAULT_GID;
  return 'https://docs.google.com/spreadsheets/d/' + id + '/export?format=csv&gid=' + gid;
})();

// Riferimenti UI
const countEl        = document.getElementById('count');
const listaGiocatori = document.getElementById('lista-giocatori');
const filtroRuolo    = document.getElementById('filtroRuolo');
const filtroSerieA   = document.getElementById('filtroSerieA');
const searchInput    = document.getElementById('searchGiocatore');
const cercaRuolo     = document.getElementById('cercaRuolo');

// Stato
let righeSvincolati = [];   // duplicati preservati
let ruoli = new Set();
let squadre = new Set();
let ordineListaAscendente = {};
let eventsBound = false;

// Config cache/refresh
const CACHE_KEY = 'svincolati_cache_unico';
const TTL = 0;                   // 0 = niente cache (sempre live)
const AUTO_REFRESH_MS = 60*1000; // auto-refresh ogni 1 minuto

// Utils
function showSpinner(show = true){ const s = document.getElementById('spinner'); if (s) s.style.display = show ? 'inline-block' : 'none'; }
function urlNoCache(url){ const sep = url.includes('?') ? '&' : '?'; return url + sep + '_cb=' + Date.now(); }
function withTimeout(promise, ms=12000){
  return Promise.race([ promise, new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')), ms)) ]);
}

const _controllers = { csv: null };
function fetchRetry(url, opt={}, tries=3, baseDelay=800, timeoutMs=12000){
  let lastErr;
  return new Promise(async (resolve, reject)=>{
    for (let i=0;i<tries;i++){
      try{
        const res = await withTimeout(fetch(urlNoCache(url), { cache:'no-store', method:'GET', ...opt }), timeoutMs);
        if (res.ok) return resolve(res);
        if (![429,500,502,503,504].includes(res.status)) throw new Error('HTTP '+res.status);
        lastErr = new Error('HTTP '+res.status);
      }catch(e){ lastErr = e; }
      const delay = baseDelay * Math.pow(2,i) + Math.random()*250; await new Promise(r=>setTimeout(r, delay));
    }
    reject(lastErr);
  });
}
function abortAndFetch(key, url, tries=3, baseDelay=800, timeoutMs=12000){
  if (_controllers[key]) _controllers[key].abort();
  const controller = new AbortController();
  _controllers[key] = controller;
  return fetchRetry(url, { signal: controller.signal }, tries, baseDelay, timeoutMs)
    .finally(()=>{ if (_controllers[key] === controller) _controllers[key] = null; });
}

// Loader CSV (usa cache solo se TTL > 0)
async function caricaSvincolati(){
  const now = Date.now();

  try{
    const cache = JSON.parse(localStorage.getItem(CACHE_KEY) || 'null');
    if (TTL > 0 && cache && (now - cache.time) < TTL && cache.csv){
      parseGiocatoriCSV(cache.csv); renderLista(); return;
    }
  }catch{/* ignore */}

  showSpinner(true);
  try{
    const res = await abortAndFetch('csv', DATASET, 3, 800, 12000);
    const csv = await res.text();
    if (TTL > 0) localStorage.setItem(CACHE_KEY, JSON.stringify({ time: now, csv }));
    parseGiocatoriCSV(csv); renderLista();
  }catch(err){
    console.error('Errore caricamento CSV svincolati:', err);
    const cache = JSON.parse(localStorage.getItem(CACHE_KEY) || 'null');
    if (cache?.csv){ parseGiocatoriCSV(cache.csv); renderLista(); }
  }finally{ showSpinner(false); }
}

// Parser CSV (preserva duplicati)
function parseGiocatoriCSV(csv){
  ruoli = new Set();
  squadre = new Set();
  righeSvincolati = [];
  const lines = csv.trim().split(/\r?\n/);
  if (lines.length <= 1) return;
  for (let i = 1; i < lines.length; i++){
    const r = lines[i]; if (!r) continue;
    const [nome, ruolo, squadra, quotazione, u21] = r.split(',');
    if (!nome) continue;
    righeSvincolati.push({ nome, ruolo, squadra, quotazione, u21 });
    if (ruolo) ruoli.add(ruolo);
    if (squadra) squadre.add(squadra);
  }
}

// Render tabella + filtri
function renderLista(){
  const frag = document.createDocumentFragment();
  righeSvincolati.forEach(({ nome, ruolo, squadra, quotazione, u21 })=>{
    const tr = document.createElement('tr');
    const isU21 = (u21||'').toLowerCase() === 'u21' ? 'U21' : '';
    tr.innerHTML =
      '<td>' + (nome||'') + '</td>' +
      '<td>' + (ruolo||'') + '</td>' +
      '<td>' + (squadra||'') + '</td>' +
      '<td>' + (parseInt(quotazione)||0) + '</td>' +
      '<td>' + isU21 + '</td>';
    frag.appendChild(tr);
  });
  listaGiocatori.innerHTML = '';
  listaGiocatori.appendChild(frag);

  filtroRuolo.innerHTML  = '<option value=\"\">-- Tutti i Ruoli --</option>' + Array.from(ruoli).map(r=>'<option value=\"'+r+'\">'+r+'</option>').join('');
  filtroSerieA.innerHTML = '<option value=\"\">-- Tutte --</option>' + Array.from(squadre).sort((a,b)=>a.localeCompare(b)).map(s=>'<option value=\"'+s+'\">'+s+'</option>').join('');

  if (!eventsBound){
    [filtroRuolo, filtroSerieA, searchInput, cercaRuolo].forEach(el => el && el.addEventListener('input', debounce(filtraLista, 150)));
    eventsBound = true;
  }

  filtraLista();
  aggiornaCount();
}

function debounce(fn, delay=150){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), delay); }; }

function filtraLista(){
  const ruoloTesto  = (cercaRuolo.value||'').toLowerCase();
  const ruoloSelect = (filtroRuolo.value||'').toLowerCase().split(/[,;\s]+/).filter(Boolean);
  const squadra     = (filtroSerieA.value||'').toLowerCase();
  const cerca       = (searchInput.value||'').toLowerCase();

  Array.from(listaGiocatori.children).forEach(row=>{
    const nome = row.children[0].textContent.toLowerCase();
    const r    = row.children[1].textContent.toLowerCase();
    const s    = row.children[2].textContent.toLowerCase();
    const ruoliGioc = r.split(/[,;\s]+/).map(p=>p.trim()).filter(Boolean);

    const matchInput   = !ruoloTesto || ruoliGioc.some(part => part.includes(ruoloTesto));
    const matchSelect  = !ruoloSelect.length || ruoloSelect.some(rs => ruoliGioc.includes(rs));
    const matchSquadra = !squadra || s === squadra;
    const matchNome    = !cerca || nome.includes(cerca);

    row.style.display = (matchInput && matchSelect && matchSquadra && matchNome) ? '' : 'none';
  });
  aggiornaCount();
}

function aggiornaCount(){
  const tot = listaGiocatori.children.length;
  let vis = 0; Array.from(listaGiocatori.children).forEach(r=>{ if (r.style.display !== 'none') vis++; });
  countEl.textContent = 'Svincolati mostrati: ' + vis + ' / ' + tot;
}

function ordinaLista(colonnaIndex, numerico=false){
  const tbody = document.getElementById('lista-giocatori');
  const righe = Array.from(tbody.querySelectorAll('tr'));
  const asc = !ordineListaAscendente[colonnaIndex];
  ordineListaAscendente[colonnaIndex] = asc;

  document.querySelectorAll('#lista-giocatori-table thead th').forEach((th, idx)=>{
    th.textContent = th.textContent.replace(/[\\u2191\\u2193]/g, '');
    if (idx === colonnaIndex) th.textContent += asc ? ' \\u2191' : ' \\u2193';
  });

  righe.sort((a,b)=>{
    const aText = a.children[colonnaIndex]?.textContent.trim();
    const bText = b.children[colonnaIndex]?.textContent.trim();
    if (numerico){
      const aNum = parseFloat(aText)||0, bNum = parseFloat(bText)||0;
      return asc ? aNum - bNum : bNum - aNum;
    } else {
      return asc ? aText.localeCompare(bText) : bText.localeCompare(aText);
    }
  });

  tbody.innerHTML = '';
  righe.forEach(r => tbody.appendChild(r));
  filtraLista();
}
window.ordinaLista = ordinaLista;

document.addEventListener('DOMContentLoaded', ()=>{
  caricaSvincolati();
  setInterval(()=>{ caricaSvincolati(); }, AUTO_REFRESH_MS); // auto-refresh live
});
</script>
</body>
</html>
