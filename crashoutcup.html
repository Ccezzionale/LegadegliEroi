<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Classifica Coppa</title>
  <style>
    :root { --bg: #f7faff; --card: #ffffff; --text: #0b1930; --muted: #6b7a90; --primary: #1f66ff; --border: #e5efff; --accent: #e9f1ff; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); }
    header { position: sticky; top: 0; z-index: 10; background: linear-gradient(180deg, #ffffff 0%, rgba(255,255,255,0.8) 100%); backdrop-filter: blur(6px); border-bottom: 1px solid var(--border); }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px 20px; }
    h1 { margin: 0; font-size: clamp(20px, 3vw, 28px); font-weight: 800; letter-spacing: 0.2px; color: var(--primary); }

    /* Toolbar */
    .toolbar { display: flex; gap: 12px; align-items: center; margin-top: 10px; flex-wrap: wrap; }
    .pill { background: var(--accent); border: 1px solid var(--border); padding: 8px 12px; border-radius: 999px; font-size: 14px; color: var(--muted); }
    .refresh { cursor: pointer; user-select: none; }

    /* Card */
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; box-shadow: 0 6px 18px rgba(9,30,66,0.05); }

    /* Desktop table */
    .table-wrap { overflow: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 720px; }
    thead th { position: sticky; top: 0; background: #fff; border-bottom: 2px solid var(--border); text-align: left; padding: 10px 12px; font-size: 13px; color: var(--muted); font-weight: 700; }
    tbody td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
    tbody tr:hover { background: #fafcff; }

    .pos { width: 44px; text-align: center; font-weight: 800; color: var(--primary); }
    .team { display: flex; align-items: center; gap: 10px; font-weight: 700; }
    .logo { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border); background: #fff; }

    /* Badges for positions (optional) */
    .badge { display: inline-block; font-size: 12px; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted); }
    .top1 { background: #fff7d6; border-color: #ffe27a; color: #7a5a00; }
    .top4 { background: #eaffea; border-color: #b7f0b7; color: #106410; }
    .bottom4 { background: #ffefef; border-color: #ffc7c7; color: #7b1212; }

    /* Mobile accordion */
    .mobile { display: none; }
    details { border: 1px solid var(--border); border-radius: 14px; background: #fff; padding: 10px 12px; }
    details + details { margin-top: 10px; }
    summary { list-style: none; cursor: pointer; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    summary::-webkit-details-marker { display: none; }
    .summary-left { display: flex; align-items: center; gap: 12px; min-width: 0; }
    .summary-title { display: flex; flex-direction: column; }
    .team-name { font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sub { font-size: 12px; color: var(--muted); }
    .accordion-body { padding: 12px 4px 4px; }
    .kv { display: grid; grid-template-columns: 1fr auto; gap: 6px 12px; font-size: 14px; }
    .kv div:nth-child(odd) { color: var(--muted); }

    @media (max-width: 800px) {
      .desktop { display: none; }
      .mobile { display: block; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Classifica Coppa</h1>
      <div class="toolbar">
        <span id="sourceInfo" class="pill">Sorgente: <code id="csvName">(imposta URL)</code></span>
        <span id="lastUpdate" class="pill">Aggiornata: —</span>
        <button id="btnRefresh" class="pill refresh">↻ Aggiorna</button>
      </div>
    </div>
  </header>

  <main class="container" style="margin-top:14px;">
    <div class="card desktop">
      <div class="table-wrap">
        <table id="tabCoppa">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="mobile" style="margin-top:12px;">
      <div id="accCoppa"></div>
    </div>
  </main>

  <script>
    // ====== CONFIGURA QUI ======
    // Pubblica il foglio Google come CSV e incolla l'URL qui
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS1pXJCNLgchygyLnGbDEsnIV3QAdPUiLcmgzMAhlzYRivXV4fnoSBW5VwiopwXEMfwk32mvdF3gWZC/pub?output=csv"; // es: https://docs.google.com/spreadsheets/d/e/.../pub?gid=...&single=true&output=csv
    // (Opzionale) cartella dei loghi. I file devono chiamarsi esattamente come il nome squadra + ".png"
    const LOGO_DIR = "img/"; // lascia stringa vuota "" per nascondere i loghi
    const COLONNA_NOME_SQUADRA = "Squadra"; // nome della colonna nel CSV per il team
    // ====== FINE CONFIG ======

    const elThead = document.querySelector('#tabCoppa thead');
    const elTbody = document.querySelector('#tabCoppa tbody');
    const elAcc = document.getElementById('accCoppa');
    const elSourceInfo = document.getElementById('csvName');
    const elLastUpdate = document.getElementById('lastUpdate');
    const btnRefresh = document.getElementById('btnRefresh');

    elSourceInfo.textContent = CSV_URL.includes('http') ? new URL(CSV_URL).hostname : '(imposta URL)';

    btnRefresh.addEventListener('click', () => loadAndRender());

    async function fetchCSV(url) {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('Errore nel caricamento CSV');
      return await res.text();
    }

    function parseCSV(text) {
      // Parser semplice che gestisce virgole e righe; per CSV complicati sostituire con PapaParse
      const rows = [];
      let i = 0, cur = '', cell = [], inQuotes = false;
      while (i < text.length) {
        const ch = text[i];
        if (ch === '"') {
          if (inQuotes && text[i+1] === '"') { cur += '"'; i++; }
          else { inQuotes = !inQuotes; }
        } else if (ch === ',' && !inQuotes) { cell.push(cur); cur = ''; }
        else if ((ch === '\n' || ch === '\r') && !inQuotes) { if (cur !== '' || cell.length) { cell.push(cur); rows.push(cell); cell = []; cur = ''; } }
        else { cur += ch; }
        i++;
      }
      if (cur !== '' || cell.length) { cell.push(cur); rows.push(cell); }
      return rows.filter(r => r.some(x => String(x).trim() !== '')); // rimuovi righe vuote
    }

    function formatDateTime(d = new Date()) {
      const pad = x => String(x).padStart(2,'0');
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function buildTable(headers, rows) {
      // HEAD: usa direttamente le intestazioni del CSV
      elThead.innerHTML = '';
      const trh = document.createElement('tr');
      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h || '';
        trh.appendChild(th);
      });
      elThead.appendChild(trh);

      // BODY (manteniamo l'ordine del CSV)
      elTbody.innerHTML = '';
      const teamIdx = headers.indexOf(COLONNA_NOME_SQUADRA);
      rows.forEach((r) => {
        const tr = document.createElement('tr');
        r.forEach((val, i) => {
          const td = document.createElement('td');
          if (i === teamIdx) {
            const wrap = document.createElement('div'); wrap.className = 'team';
            if (LOGO_DIR) {
              const img = document.createElement('img');
              img.className = 'logo';
              img.alt = val;
              img.loading = 'lazy';
              img.src = `${LOGO_DIR}${val}.png`;
              wrap.appendChild(img);
            }
            const span = document.createElement('span'); span.textContent = val; wrap.appendChild(span);
            td.appendChild(wrap);
          } else {
            td.textContent = val;
          }
          tr.appendChild(td);
        });
        elTbody.appendChild(tr);
      });
    }

    function buildAccordion(headers, rows) {
      elAcc.innerHTML = '';
      const teamIdx = headers.indexOf(COLONNA_NOME_SQUADRA);
      const posIdx = headers.findIndex(h => h.toLowerCase().trim() === 'pos');
      // Preferisci "Pt." esatto, altrimenti la prima colonna che contiene 'pt' ma non 'totali'
      let ptIdx = headers.findIndex(h => h.trim().toLowerCase() === 'pt.' || h.trim().toLowerCase() === 'pt');
      if (ptIdx < 0) {
        ptIdx = headers.findIndex(h => /pt/i.test(h) && !/totali/i.test(h));
      }

      rows.forEach((r, idx) => {
        const teamName = teamIdx >= 0 ? r[teamIdx] : `Squadra ${idx+1}`;
        const posValue = posIdx >= 0 ? r[posIdx] : String(idx + 1);
        const puntiValue = ptIdx >= 0 ? r[ptIdx] : '';

        const details = document.createElement('details');
        const summary = document.createElement('summary');

        const left = document.createElement('div'); left.className = 'summary-left';
        const pos = document.createElement('span'); pos.className = 'badge'; pos.textContent = `#${posValue}`; left.appendChild(pos);
        if (LOGO_DIR) {
          const img = document.createElement('img'); img.className = 'logo'; img.alt = teamName; img.src = `${LOGO_DIR}${teamName}.png`; left.appendChild(img);
        }
        const title = document.createElement('div'); title.className = 'summary-title';
        const name = document.createElement('div'); name.className = 'team-name'; name.textContent = teamName; title.appendChild(name);
        const sub = document.createElement('div'); sub.className = 'sub';
        sub.textContent = (puntiValue !== '' ? `Pt.: ${puntiValue}` : '');
        title.appendChild(sub);

        left.appendChild(title);
        summary.appendChild(left);
        const caret = document.createElement('span'); caret.textContent = '▾'; caret.style.color = 'var(--muted)'; summary.appendChild(caret);
        details.appendChild(summary);

        const body = document.createElement('div'); body.className = 'accordion-body';
        const kv = document.createElement('div'); kv.className = 'kv';
        headers.forEach((h, i) => {
          // Niente duplicati per Pos e Squadra nella sezione dettagli
          if (!h || i === teamIdx || i === posIdx) return;
          const k = document.createElement('div'); k.textContent = h;
          const v = document.createElement('div'); v.textContent = r[i];
          kv.appendChild(k); kv.appendChild(v);
        });
        body.appendChild(kv);
        details.appendChild(body);

        elAcc.appendChild(details);
      });
    }

    async function loadAndRender() {
      try {
        const text = await fetchCSV(CSV_URL);
        const parsed = parseCSV(text);
        if (!parsed.length) throw new Error('CSV vuoto');
        const headers = parsed[0].map(h => String(h).trim());
        const rows = parsed.slice(1);
        buildTable(headers, rows);
        buildAccordion(headers, rows);
        elLastUpdate.textContent = `Aggiornata: ${formatDateTime(new Date())}`;
      } catch (e) {
        console.error(e);
        alert('Impossibile caricare la classifica della Coppa. Controlla l\'URL CSV.');
      }
    }

    // Avvio
    loadAndRender();
  </script>
</body>
</html>
